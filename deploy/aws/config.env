#!/bin/bash
# AWS Deployment Configuration for Retaining Wall Application
# Source this file before running any deployment scripts:
#   source config.env

# =============================================================================
# REQUIRED: User must configure these values before deployment
# =============================================================================

# Your domain name (e.g., retainingwall.com, walldesign.io)
export DOMAIN_NAME="${DOMAIN_NAME:-your-domain.com}"

# AWS EC2 Key Pair name (create in AWS Console > EC2 > Key Pairs)
export SSH_KEY_NAME="${SSH_KEY_NAME:-retaining-wall-key}"

# Email for Let's Encrypt certificate notifications
export ADMIN_EMAIL="${ADMIN_EMAIL:-admin@your-domain.com}"

# Route 53 Hosted Zone ID (set after creating hosted zone, or leave empty if using external DNS)
export HOSTED_ZONE_ID="${HOSTED_ZONE_ID:-}"

# =============================================================================
# AWS Settings (defaults are recommended)
# =============================================================================

export AWS_REGION="${AWS_REGION:-us-west-2}"
export AWS_PROFILE="${AWS_PROFILE:-default}"

# =============================================================================
# VPC Configuration
# =============================================================================

export VPC_CIDR="${VPC_CIDR:-10.0.0.0/16}"
export PUBLIC_SUBNET_CIDR="${PUBLIC_SUBNET_CIDR:-10.0.1.0/24}"
export VPC_NAME="${VPC_NAME:-retaining-wall-vpc}"

# =============================================================================
# EC2 Configuration
# =============================================================================

# Instance type: t3.small recommended for production (2 vCPU, 2GB RAM)
# Use t3.micro for testing (free tier eligible)
export INSTANCE_TYPE="${INSTANCE_TYPE:-t3.small}"

# Ubuntu 22.04 LTS AMI - auto-detected by create-ec2.sh
export AMI_ID="${AMI_ID:-}"

export INSTANCE_NAME="${INSTANCE_NAME:-retaining-wall-server}"

# EBS volume size in GB
export EBS_SIZE="${EBS_SIZE:-30}"

# =============================================================================
# Application Settings
# =============================================================================

export APP_USER="${APP_USER:-ubuntu}"
export DEPLOY_USER="${DEPLOY_USER:-github-deploy}"
export APP_DIR="${APP_DIR:-/opt/rwcpp}"
export WEB_DIR="${WEB_DIR:-/var/www/retainingwall}"
export LOG_DIR="${LOG_DIR:-/var/log/rwcpp}"

# =============================================================================
# Resource IDs - Populated by deployment scripts
# Do not edit these manually - they are set automatically
# =============================================================================

export VPC_ID="${VPC_ID:-}"
export SUBNET_ID="${SUBNET_ID:-}"
export IGW_ID="${IGW_ID:-}"
export RTB_ID="${RTB_ID:-}"
export SG_ID="${SG_ID:-}"
export INSTANCE_ID="${INSTANCE_ID:-}"
export EIP_ALLOC_ID="${EIP_ALLOC_ID:-}"
export ELASTIC_IP="${ELASTIC_IP:-}"

# =============================================================================
# Helper Functions
# =============================================================================

# Save current config to file
save_config() {
    local config_file="${1:-$(dirname "$0")/config.env}"
    cat > "${config_file}" << CONFIGEOF
#!/bin/bash
# AWS Deployment Configuration - Auto-saved $(date)

# User Configuration
export DOMAIN_NAME="${DOMAIN_NAME}"
export SSH_KEY_NAME="${SSH_KEY_NAME}"
export ADMIN_EMAIL="${ADMIN_EMAIL}"
export HOSTED_ZONE_ID="${HOSTED_ZONE_ID}"

# AWS Settings
export AWS_REGION="${AWS_REGION}"
export AWS_PROFILE="${AWS_PROFILE}"

# VPC Configuration
export VPC_CIDR="${VPC_CIDR}"
export PUBLIC_SUBNET_CIDR="${PUBLIC_SUBNET_CIDR}"
export VPC_NAME="${VPC_NAME}"

# EC2 Configuration
export INSTANCE_TYPE="${INSTANCE_TYPE}"
export AMI_ID="${AMI_ID}"
export INSTANCE_NAME="${INSTANCE_NAME}"
export EBS_SIZE="${EBS_SIZE}"

# Application Settings
export APP_USER="${APP_USER}"
export DEPLOY_USER="${DEPLOY_USER}"
export APP_DIR="${APP_DIR}"
export WEB_DIR="${WEB_DIR}"
export LOG_DIR="${LOG_DIR}"

# Resource IDs (populated by scripts)
export VPC_ID="${VPC_ID}"
export SUBNET_ID="${SUBNET_ID}"
export IGW_ID="${IGW_ID}"
export RTB_ID="${RTB_ID}"
export SG_ID="${SG_ID}"
export INSTANCE_ID="${INSTANCE_ID}"
export EIP_ALLOC_ID="${EIP_ALLOC_ID}"
export ELASTIC_IP="${ELASTIC_IP}"
CONFIGEOF
    echo "Configuration saved to ${config_file}"
}

# Validate required settings
validate_config() {
    local errors=0

    if [[ "${DOMAIN_NAME}" == "your-domain.com" ]]; then
        echo "ERROR: DOMAIN_NAME not configured"
        errors=$((errors + 1))
    fi

    if [[ "${SSH_KEY_NAME}" == "retaining-wall-key" ]]; then
        echo "WARNING: Using default SSH_KEY_NAME. Make sure this key pair exists in AWS."
    fi

    if [[ "${ADMIN_EMAIL}" == "admin@your-domain.com" ]]; then
        echo "ERROR: ADMIN_EMAIL not configured"
        errors=$((errors + 1))
    fi

    # Check AWS CLI is installed and configured
    if ! command -v aws &> /dev/null; then
        echo "ERROR: AWS CLI not installed"
        errors=$((errors + 1))
    elif ! aws sts get-caller-identity &> /dev/null; then
        echo "ERROR: AWS CLI not configured or credentials invalid"
        errors=$((errors + 1))
    fi

    return ${errors}
}

echo "Retaining Wall AWS Deployment Configuration loaded"
echo "Domain: ${DOMAIN_NAME}"
echo "Region: ${AWS_REGION}"
